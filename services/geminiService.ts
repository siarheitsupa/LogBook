import { GoogleGenAI } from "@google/genai";
import { Shift } from "../types";
import { calculateShiftDurationMins } from "../utils/timeUtils";

export const analyzeLogs = async (shifts: Shift[]): Promise<string> => {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å–º–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    const recentShifts = shifts.slice(-15);

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è AI —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Ç–¥—ã—Ö–∞
    const history = recentShifts.map((s, index) => {
      const duration = calculateShiftDurationMins(s);
      const h = Math.floor(duration / 60);
      const m = Math.round(duration % 60);
      
      // Fix: Use startDate instead of date
      return `üìÖ ${s.startDate}: –í–æ–∂–¥–µ–Ω–∏–µ ${s.driveHours}—á ${s.driveMinutes}–º. –°–º–µ–Ω–∞: ${s.startTime} - ${s.endTime}.`;
    }).join('\n');

    const promptText = `
      –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ª–æ–≥–∏ –≤–æ–¥–∏—Ç–µ–ª—è –ø–æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—É –ï–° 561/2006.
      –î–∞–Ω–Ω—ã–µ:
      ${history}

      –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ —ç—Ç–∏—Ö –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö (–ù–ï –ø—Ä–æ–≤–µ—Ä—è–π 4.5 —á–∞—Å–∞, —ç—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å–∞–º):
      1. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –≤–æ–∂–¥–µ–Ω–∏—è: > 56 —á–∞—Å–æ–≤.
      2. –î–≤—É—Ö–Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –≤–æ–∂–¥–µ–Ω–∏—è: > 90 —á–∞—Å–æ–≤.
      3. –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –≤–æ–∂–¥–µ–Ω–∏—è: > 9 —á–∞—Å–æ–≤ (–∏–ª–∏ > 10 —á–∞—Å–æ–≤ –±–æ–ª–µ–µ 2 —Ä–∞–∑ –∑–∞ –Ω–µ–¥–µ–ª—é).
      4. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö: –±—ã–ª –ª–∏ –æ—Ç–¥—ã—Ö –º–µ–Ω–µ–µ 45 —á–∞—Å–æ–≤?
      5. –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç–¥—ã—Ö: –º–µ–Ω–µ–µ 11 —á–∞—Å–æ–≤ (–∏–ª–∏ 9 —á–∞—Å–æ–≤ –ø—Ä–∏ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–º). –°–º–æ—Ç—Ä–∏ –Ω–∞ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –æ–¥–Ω–æ–π —Å–º–µ–Ω—ã –∏ –Ω–∞—á–∞–ª–æ–º —Å–ª–µ–¥—É—é—â–µ–π.

      –û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
      
      ‚úÖ **–°—Ç–∞—Ç—É—Å:** [–ù–æ—Ä–º–∞ / –†–∏—Å–∫ / –ù–∞—Ä—É—à–µ–Ω–∏–µ]
      
      üö® **–í—ã—è–≤–ª–µ–Ω–æ:**
      [–û–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ —Å –¥–Ω—è–º–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏. –ï—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –Ω–∞–ø–∏—à–∏ "–í—Å–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã"]
      
      üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
      [–°–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –æ—Ç–¥—ã—Ö–∞—Ç—å —Å–µ–π—á–∞—Å –∏–ª–∏ –Ω–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å —Å–¥–µ–ª–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤]
    `;

    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: promptText,
      config: {
        systemInstruction: "–¢—ã ‚Äî —Å—Ç–∞—Ä—à–∏–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ï–° 561/2006. –¢—ã –ø—Ä–æ–≤–µ—Ä—è–µ—à—å —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç–¥—ã—Ö–∞. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ –ø–æ –¥–µ–ª—É.",
        temperature: 0.3,
      }
    });

    let text = response.text || "–û—à–∏–±–∫–∞: –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç.";
    
    return text.trim();
    
  } catch (error: any) {
    console.error("Gemini Error:", error);

    if (error.message?.includes('429') || error.message?.includes('quota') || error.message?.includes('limit')) {
      return "‚ö†Ô∏è **–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω.**\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.";
    }
    
    return `‚ùå **–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:**\n\n–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.`;
  }
};